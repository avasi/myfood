<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/jquery.csv.min.js"></script>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <title>myfoodpi Local Manager</title>

    <link rel="icon" href="content/logoMyFoodTiny.png">
    <!-- CSS -->
    <link href="css/theme.min.css" rel="stylesheet">
    <style style="display:none">
      body {
        padding-top: 50px;
      }
      .starter-template {
        padding: 40px 15px;
        text-align: center;
      }

      .navbar-image {
        padding: 0 15px;
      }
      .navbar-image img {
        max-height: 50px;
      }

      .graph {
        max-width: 100%;
      }

      @media (max-width: 991px) {
        .graph {
          margin-left: -20px;
        }
      }

    .footer {
            background-color: #219352;
            border-color: #219352;
            padding-top: 48px;
            padding-bottom: 48px;
            color: #fff;
            font-family: 'Open Sans';
        }

	.footerLogo{
		width: 25%;
	}

	.gpl {
	    float: left;
		position: relative;
		min-height: 1px;
		padding-left: 15px;
		padding-right: 15px;
		width: 50%;
		display: block;
	}

	.gpl a {
		text-decoration: none;
		moz-transition: color .2s;
		-o-transition: color .2s;
		-webkit-transition: color .2s;
		transition: color .2s;
		color: #c4decf;
		background-color: transparent;

	}

	.gpl .gpl-text {
	    padding: 0 15px;
		position:absolute;
		padding: 30px 0 0 15px;
	}

	.gpl .gpl-link {
		cursor: default;
	}

    .niceButton {
            background-color: #219352;
            color: white;
            display: block;
            width: 100%;
    }

    </style>

  </head>

  <body style="background-color:#eeeeee">

    <!-- NavBar -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">

          <button type="button" class="navbar-toggle collapsed"  data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

          <a class="navbar-image pull-left" href="/">
              <img src="content/logoOwnFoodTiny.png"/>
          </a>

        </div>
        <div id="navbar" class="collapse navbar-collapse" >
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Production Unit</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Jumbotron Title -->
    <div class="jumbotron">
      <div class="container">
        <h1 class="hidden-xs">Local Production Unit Manager</h1>
        <h2 class="visible-xs">myfoodpi monitoring</h2>
      </div>
    </div>

    <!-- Content -->
    <div class="container">
        <div class="row">
                <div class="col-xs-12 col-sm-6">
                  <div class="panel panel-success">
                    <div class="panel-heading">Water temperature</div>
                    <div class="panel-body">
                      <div id="waterTemp" class="graph"></div>
                    </div>
                  </div>
                </div>
                <div class="col-xs-12 col-sm-6">
                  <div class="panel panel-success">
                    <div class="panel-heading">Water pH</div>
                    <div class="panel-body">
                      <div id="pH" class="graph"></div>
                    </div>
                  </div>
		         </div>
        </div>
        <div class="row">
		         <div class="col-xs-12 col-sm-6">
                  <div class="panel panel-success">
                    <div class="panel-heading">Air Temperature</div>
                    <div class="panel-body">
                      <div id="airTemp" class="graph"></div>
                    </div>
		        </div>
		        </div>
		        <div class="col-xs-12 col-sm-6">
                  <div class="panel panel-success">
                    <div class="panel-heading">Air Humidity</div>
                    <div class="panel-body">
                      <div id="airHum" class="graph"></div>
                    </div>
                  </div>
                  </div>
           </div>
        <div class="row">
              <div class="col-xs-12 col-sm-6">
                  <div class="panel panel-success">
                      <div class="panel-heading">Settings</div>
                      <div class="panel-body">
                          
                      </div>
                  </div>
              </div>
              <div class="col-xs-12 col-sm-6">
                  <div class="panel panel-success">
                      <div class="panel-heading">Admin Console</div>
                      <div class="panel-body">
                          <button class="niceButton" onclick="onSetpHTo7Click()">Set pH Calibration to 7</button>
                          <button class="niceButton" onclick="onResetToFactoryClick()">Reset Calibration to Factory</button>
                          <button class="niceButton" onclick="onDownloadMeasuresClick()">Download Measures</button>
                          <button class="niceButton" onclick="onDownloadLogsClick()">Download Log</button>
                          <button class="niceButton" onclick="onEraseLogsClick()">Erase Logs</button>
                          <button class="niceButton" onclick="onEraseMeasuresClick()">Erase Measures</button>
                          <button class="niceButton" onclick="onRestartAppClick()">Restart App</button>
                      </div>
                  </div>
              </div>
      </div>
    </div>

    <!-- Footer -->
  	<footer class="footer">
      <div class="container">
		<div class="row">
			<div class="gpl">
				<div class="gpl-link navbar-image pull-left">
					<img src="content/gpl.png"/>
				</div>
				<div class="gpl-text">
                    <p style="padding-top:20px">.:myfoodapp is licensed under a GPLv3:.</p>
				 </div>
			</div>
			<div class="footerlogo">
				<p class="navbar-image pull-right">
                   <img src="content/logoMyFoodFooter.png" />
                    <br/>
					contact@myfood.eu
				</p>
			</div>
		</div>
	  </div>
    </footer>

    <script type="text/javascript" src="js/dygraph-combined.js"></script>
    <script>
        window.onload = function onLoad(e) {

            getpH();
            getWaterTemp();
            getAirTemp();
            getAirHum();                 
        };

        function getpH() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/data/type/pH", true);

            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var str = JSON.parse(xhr.responseText);
                        var dataArr = $.csv.toArrays(str);

                        for (i = 0; i < dataArr.length; i++) {
                            dataArr[i][0] = new Date(dataArr[i][0]);
                        }
                        new Dygraph(document.getElementById("pH"), dataArr, { labels: ["Date", "pH"], includeZero: true });
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };

            xhr.send();
        };

        function getWaterTemp() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/data/type/waterTemp", true);

            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var str = JSON.parse(xhr.responseText);
                        var dataArr = $.csv.toArrays(str);

                        for (i = 0; i < dataArr.length; i++) {
                            dataArr[i][0] = new Date(dataArr[i][0]);
                        }
                        new Dygraph(document.getElementById("waterTemp"), dataArr, { labels: ["Date", "Celsius"], includeZero: true });
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };

            xhr.send();
        };

        function getAirTemp() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/data/type/airTemp", true);

            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var str = JSON.parse(xhr.responseText);
                        var dataArr = $.csv.toArrays(str);

                        for (i = 0; i < dataArr.length; i++) {
                            dataArr[i][0] = new Date(dataArr[i][0]);
                        }
                        new Dygraph(document.getElementById("airTemp"), dataArr, { labels: ["Date", "Celsius"], includeZero: true });
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };

            xhr.send();
        };

        function getAirHum() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/data/type/airHum", true);

            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var str = JSON.parse(xhr.responseText);
                        var dataArr = $.csv.toArrays(str);

                        for (i = 0; i < dataArr.length; i++) {
                            dataArr[i][0] = new Date(dataArr[i][0]);
                        }
                        new Dygraph(document.getElementById("airHum"), dataArr, { labels: ["Date", "%"], includeZero: true });
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };

            xhr.send();
        };

        function onRestartAppClick() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/restartApp", true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.send();
        };

        function onEraseLogsClick() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/eraseLogs", true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.send();
        };

        function onEraseMeasuresClick() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/eraseMeasures", true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.send();
        };

        function onSetpHTo7Click() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/setPHTo7", true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.send();
        };

        function onResetToFactoryClick() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/resetToFactory", true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.send();
        };

        var headersMeasures = {
            date: "Date",
            sensor: "Sensor",
            value: "Value"
        };

        var headersLogs = {
            date: "Date",
            type: "Type",
            description: "Content",
            stackCall: "StackCall"
        };

        function onDownloadMeasuresClick() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/measuresFile", true);

            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth() + 1;
                        var day = date.getDate();
                        var fileName = "data_" + year + "-" + month + "-" + day + ".csv";

                        var data = JSON.parse(xhr.responseText);
                        exportCSVFile(headersMeasures, data, fileName);

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };

            xhr.send();          
        };

        function onDownloadLogsClick() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://myfoodpi:5000/api/logsFile", true);

            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var date = new Date();
                        var year = date.getFullYear();
                        var month = date.getMonth() + 1;
                        var day = date.getDate();
                        var fileName = "data_" + year + "-" + month + "-" + day + ".csv";

                        var data = JSON.parse(xhr.responseText);
                        exportCSVFile(headersLogs, data, fileName);

                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };

            xhr.send();
        };

        function convertToCSV(objArray) {
            var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
            var str = '';

            for (var i = 0; i < array.length; i++) {
                var line = '';
                for (var index in array[i]) {
                    if (line != '') line += ';'

                    line += array[i][index];
                }

                str += line + '\r\n';
            }

            return str;
        }

        function exportCSVFile(headers, items, fileTitle) {
            if (headers) {
                items.unshift(headers);
            }

            var jsonObject = JSON.stringify(items);

            var csv = this.convertToCSV(jsonObject);

            var exportedFilenmae = fileTitle + '.csv' || 'export.csv';

            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, exportedFilenmae);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) { 
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", exportedFilenmae);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }
    </script>

  </body>
</html>
